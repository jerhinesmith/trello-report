#!/usr/bin/env ruby

$VERBOSE = nil
require 'rubygems'
require 'bundler/setup'
require 'dotenv/load'
require 'trello'
require 'erb'
require 'fog/aws'

DEFAULT_DUE_DATE = Time.now + (60 * 60 * 24 * 30)

Trello.configure do |config|
  config.developer_public_key = ENV['TRELLO_DEVELOPER_PUBLIC_KEY']
  config.member_token = ENV['TRELLO_MEMBER_TOKEN']
end

board = Trello::Board.find(ENV['BOARD_ID'])

members = board.members.select{ |m| ENV['ENGINEERS'].split(',').include?(m.username) }
upcoming_lists = board.lists.select{ |l| ['Staged', 'Approved'].include?(l.name) }
working_list = board.lists.find{ |l| l.name == 'In Progress' }
next_list = board.lists.find{ |l| l.name == 'Next' }
deployed_list = board.lists.select{ |l| l.name =~ /Live\sthis\sweek$/i }.first

# Grab all the cards so we don't have to make multiple requests
cards = board.cards

# Get the upcoming cards
@upcoming_cards  = cards.select{ |c| upcoming_lists.collect(&:id).include?(c.list_id) && !c.due.nil? }.sort_by(&:due)
@working_cards   = cards.select{ |c| c.list_id == working_list.id }.sort_by{|c| c.due || DEFAULT_DUE_DATE }
@deployed_cards  = cards.select{ |c| c.list_id == deployed_list.id }

report_template = File.read(File.expand_path('../../views/index.html.erb', __FILE__))
renderer = ERB.new(report_template)

# jruby?
Excon.defaults[:ciphers] = 'DEFAULT'

# create a connection
connection = Fog::Storage.new({
  provider:               'AWS',
  aws_access_key_id:      ENV['AWS_ACCESS_KEY_ID'],
  aws_secret_access_key:  ENV['AWS_SECRET_ACCESS_KEY']
})

# First, a place to contain the glorious details
directory = connection.directories.create(
  key:    'engineering.questlearning.org',
  public: true
)

# Upload the quest json
report = directory.files.create(
  key:    'report.html',
  body:   renderer.result(binding),
  public: true
)

puts report.public_url
